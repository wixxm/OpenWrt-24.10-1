name: Sync OpenWrt 24.10 to Main

permissions:
  contents: write  # å…è®¸å†™å…¥å†…å®¹

on:
  push:
    paths:
      - '.github/workflows/main.yml'
  schedule:
    - cron: 0 */12 * * *  # æ¯12å°æ—¶è¿è¡Œä¸€æ¬¡
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      # 1. å…‹éš† OpenWrt å®˜æ–¹ä»“åº“çš„ 24.10 åˆ†æ”¯å¹¶åŒ…å« .git ä¿¡æ¯
      - name: Clone OpenWrt Repository
        run: |
          git clone --branch openwrt-24.10 https://github.com/openwrt/openwrt.git openwrt
          cd openwrt
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      # 2. å…‹éš†ç›®æ ‡ä»“åº“ï¼ˆæ‚¨çš„ä»“åº“ï¼‰
      - name: Clone Your Repository
        env:
          PAT: ${{ secrets.PAT_TOKEN }}
        run: |
          git clone https://x-access-token:${PAT}@github.com/wixxm/openwrt-24.10-1.git target_repo

      # 3. æ£€æŸ¥å¹¶åˆå§‹åŒ–ç›®æ ‡ä»“åº“åˆ†æ”¯
      - name: Ensure Target Repo Branch
        run: |
          cd target_repo
          if ! git rev-parse --verify main >/dev/null 2>&1; then
            git checkout -b main
          fi

      # 4. å¤‡ä»½ .github æ–‡ä»¶å¤¹å’Œéœ€è¦ä¿ç•™çš„æ–‡ä»¶
      - name: Backup Existing Files
        run: |
          mkdir -p backup
          # å¤‡ä»½ .github æ–‡ä»¶å¤¹
          if [ -d "target_repo/.github" ]; then
            mv target_repo/.github backup/github_backup
          fi
          

      # 5. å°† OpenWrt ä»“åº“çš„å†…å®¹åŒæ­¥åˆ°ç›®æ ‡ä»“åº“ï¼ˆåŒ…å« .git ä¿¡æ¯ï¼‰
      - name: Sync OpenWrt Changes and .git Info
        run: |
          # åŒæ­¥æºç å†…å®¹
          rsync -av --delete --exclude='.github' openwrt/ target_repo/
          # åŒæ­¥ .git ä¿¡æ¯
          rsync -av --delete openwrt/.git/ target_repo/.git/

      # 6. æ›´æ–°è¿œç¨‹ä»“åº“ URL å¹¶æ£€æŸ¥/åˆ‡æ¢åˆ†æ”¯
      - name: Update Remote URL and Checkout Branch
        run: |
          cd target_repo
          # æ›´æ–°è¿œç¨‹ä»“åº“ URL
          git remote set-url origin https://x-access-token:${{ secrets.PAT_TOKEN }}@github.com/wixxm/openwrt-24.10-1.git

          # æ£€æŸ¥å¹¶åˆ‡æ¢åˆ° main åˆ†æ”¯ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»ºå®ƒ
          if ! git rev-parse --verify main >/dev/null 2>&1; then
            git checkout -b main
          else
            git checkout main
          fi

      # 7. æ¢å¤å¤‡ä»½çš„æ–‡ä»¶å’Œæ–‡ä»¶å¤¹
      - name: Restore Backup Files
        run: |
          # æ¢å¤ .github æ–‡ä»¶å¤¹
          if [ -d "backup/github_backup" ]; then
            mv backup/github_backup target_repo/.github
          fi
          

      # 8. æäº¤å¹¶æ¨é€æ›´æ”¹
      - name: Commit and Push Changes
        env:
          PAT: ${{ secrets.PAT_TOKEN }}
        run: |
          cd target_repo
          # é…ç½® Git ç”¨æˆ·ä¿¡æ¯
          git config user.name "wixxm"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # æ‹‰å–è¿œç¨‹åˆ†æ”¯å¹¶åˆå¹¶
          git fetch origin main || true
          git merge --no-edit origin/main || true

          # æäº¤æ›´æ”¹
          git add .
          git commit -m "ğŸ… Sync OpenWrt 24.10 with .git information" || echo "æ²¡æœ‰æ–°çš„æ›´æ”¹å¯æäº¤"

          # æ¨é€æ›´æ–°åˆ°è¿œç¨‹ä»“åº“
          git push origin main || (echo "å¼ºåˆ¶æ¨é€ä¸­..." && git push origin main --force)
